<!DOCTYPE html>
  <html lang="ja">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta http-equiv="X-UA-Compatible" content="ie=edge" />
      <title>Document</title>
    </head>
    <body>
      <div>macro sample</div>
      <pre>
Option Explicit
Option Base 1

Public Sub aaaListArrange()
    
    With ThisWorkbook.Worksheets(1)
        If .Cells(.Rows.Count, 2).End(xlUp).Row >= 3 Then _
            .Range(.Cells(3, 2), .Cells(.Rows.Count, 2).End(xlUp)).ClearContents
    End With
    
    Call PsubProc1
    Call PsubProc2
    
End Sub

Private Sub PsubProc1()
    
'//シート上の指定範囲またはデータ全範囲のデータを配列に取込む
  Dim myXobjSheet As Object, myXobjFrstCell As Object, myXobjLastCell As Object
    Set myXobjSheet = ThisWorkbook.Worksheets("Proc")
  Dim myXlonRowCnt As Long, myXlonColCnt As Long, myZstrDataAry() As String
    Call PfixGetSheetRangeData(myXlonRowCnt, myXlonColCnt, myZstrDataAry, _
            myXobjSheet, myXobjFrstCell, myXobjLastCell)
    If myXlonRowCnt <= 0 Or myXlonColCnt <= 0 Then Exit Sub

'//2次元配列の指定列で文字列を検索して指定列の同じ行にある値の一覧を取得
  Dim myXstrIfCndtn As String
    myXstrIfCndtn = " '定型"
  Dim myXlonValCnt As Long, myZstrValAry() As String
    Call PfixVLookupExtendedString(myXlonValCnt, myZstrValAry, _
            myXstrIfCndtn, myZstrDataAry, 2, 2, True)
    If myXlonValCnt <= 0 Then Exit Sub

'//文字列が格納された1次元配列を2次元配列に入れ替える
  Dim myZvarWrtAry As Variant
    Call PfixTranspose1DArrayTo2DArrayForString(myZvarWrtAry, myZstrValAry, True)

'//2次元配列変数のデータ一覧をシートに一括書出し
    With ThisWorkbook.Worksheets(1)
        Set myXobjFrstCell = .Cells(.Rows.Count, 2).End(xlUp).Offset(1)
    End With
  Dim myXbisExitFlag As Boolean
    Call PfixWriteArrayVariablesToWorkSheet(myXbisExitFlag, _
            myXobjFrstCell, myZvarWrtAry, False)
    If myXbisExitFlag = True Then Exit Sub

End Sub

Private Sub PsubProc2()
    
'//シート上の指定範囲またはデータ全範囲のデータを配列に取込む
  Dim myXobjSheet As Object, myXobjFrstCell As Object, myXobjLastCell As Object
    Set myXobjSheet = ThisWorkbook.Worksheets("Code")
  Dim myXlonRowCnt As Long, myXlonColCnt As Long, myZstrDataAry() As String
    Call PfixGetSheetRangeData(myXlonRowCnt, myXlonColCnt, myZstrDataAry, _
            myXobjSheet, myXobjFrstCell, myXobjLastCell)
    If myXlonRowCnt <= 0 Or myXlonColCnt <= 0 Then Exit Sub

'//2次元配列の指定列で文字列を検索して指定列の同じ行にある値の一覧を取得
  Dim myXstrIfCndtn As String
    myXstrIfCndtn = " '定型"
  Dim myXlonValCnt As Long, myZstrValAry() As String
    Call PfixVLookupExtendedString(myXlonValCnt, myZstrValAry, _
            myXstrIfCndtn, myZstrDataAry, 2, 2, True)
    If myXlonValCnt <= 0 Then Exit Sub

'//文字列が格納された1次元配列を2次元配列に入れ替える
  Dim myZvarWrtAry As Variant
    Call PfixTranspose1DArrayTo2DArrayForString(myZvarWrtAry, myZstrValAry, True)

'//2次元配列変数のデータ一覧をシートに一括書出し
    With ThisWorkbook.Worksheets(1)
        Set myXobjFrstCell = .Cells(.Rows.Count, 2).End(xlUp).Offset(1)
    End With
  Dim myXbisExitFlag As Boolean
    Call PfixWriteArrayVariablesToWorkSheet(myXbisExitFlag, _
            myXobjFrstCell, myZvarWrtAry, False)
    If myXbisExitFlag = True Then Exit Sub

End Sub

 '定型Ｐ_シート上の指定範囲またはデータ全範囲のデータを配列に取込む
Private Sub PfixGetSheetRangeData( _
            myXlonRowCnt As Long, myXlonColCnt As Long, myZstrDataAry() As String, _
            myXobjSheet As Object, myXobjFrstCell As Object, myXobjLastCell As Object)
    myXlonRowCnt = Empty: myXlonColCnt = Empty: Erase myZstrDataAry
    If myXobjSheet Is Nothing Then Exit Sub
'//シート上の指定範囲をオブジェクト配列に取込む
  Dim myXobjShtRng As Object
    With myXobjSheet
        If myXobjFrstCell Is Nothing Then Set myXobjFrstCell = .Cells(1, 1)
        If myXobjLastCell Is Nothing Then _
                Set myXobjLastCell = .Cells.SpecialCells(xlCellTypeLastCell)
        Set myXobjShtRng = .Range(myXobjFrstCell, myXobjLastCell)
    End With
    With myXobjShtRng
        myXlonRowCnt = .Rows.Count
        myXlonColCnt = .Columns.Count
    End With
    If myXlonRowCnt = 0 Or myXlonColCnt = 0 Then Exit Sub
'//オブジェクト配列からデータを取得
  Dim myZvarRngData As Variant, i As Long, j As Long
    myZvarRngData = myXobjShtRng.Value
    ReDim myZstrDataAry(myXlonRowCnt, myXlonColCnt) As String
    If myXlonRowCnt = 1 And myXlonColCnt = 1 Then
        myZstrDataAry(1, 1) = myZvarRngData
    Else
        For j = LBound(myZvarRngData, 2) To UBound(myZvarRngData, 2)
            For i = LBound(myZvarRngData, 1) To UBound(myZvarRngData, 1)
                myZstrDataAry(i, j) = myZvarRngData(i, j)
            Next i
        Next j
    End If
    Set myXobjShtRng = Nothing: myZvarRngData = Empty
End Sub

 '定型Ｐ_2次元配列の指定列で文字列を検索して指定列の同じ行にある値の一覧を取得する
Private Sub PfixVLookupExtendedString( _
            myXlonValCnt As Long, myZstrValAry() As String, _
            myXstrIfCndtn As String, myZstrDataAry() As String, _
            Optional coXlonSrchCol As Long = 1, _
            Optional coXlonGetCol As Long = 1, _
            Optional coXbisInStrOptn As Boolean = False)
'myZstrValAry(i) : 取得値
'coXlonSrchCol : 検索する列番号を指定
'coXlonGetCol  : 値を取得する列番号を指定
'coXbisInStrOptn = False : 指定文字列と一致する条件
'coXbisInStrOptn = True  : 指定文字列を含む条件
    myXlonValCnt = Empty: Erase myZstrValAry
    If myXstrIfCndtn = "" Then Exit Sub
  Dim i As Long, j As Long
    On Error GoTo ExitPath
    i = UBound(myZstrDataAry, 1): j = UBound(myZstrDataAry, 2)
    On Error GoTo 0
    If coXlonSrchCol <= 0 Or j < coXlonSrchCol Then Exit Sub
    If coXlonGetCol <= 0 Or j < coXlonGetCol Then Exit Sub
  Dim myXstrTmp As String, n As Long: n = 0
    For i = LBound(myZstrDataAry, 1) To UBound(myZstrDataAry, 1)
        myXstrTmp = myZstrDataAry(i, coXlonSrchCol)
        Select Case coXbisInStrOptn
            Case True: If InStr(myXstrTmp, myXstrIfCndtn) = 0 Then GoTo NextPath
            Case Else: If myXstrTmp <> myXstrIfCndtn Then GoTo NextPath
        End Select
        n = n + 1: ReDim Preserve myZstrValAry(n) As String
        myZstrValAry(n) = myZstrDataAry(i, coXlonGetCol)
NextPath:
    Next i
    myXlonValCnt = n
ExitPath:
End Sub

 '定型Ｐ_文字列が格納された1次元配列を2次元配列に入れ替える
Private Sub PfixTranspose1DArrayTo2DArrayForString( _
            myZvarNewAry As Variant, myZvarOrgAry As Variant, _
            Optional coXbisRowDrctn As Boolean = True)
'coXbisRowDrctn = True   : 行方向に並べる
'coXbisRowDrctn = False  : 列方向に並べる
    If VarType(myZvarNewAry) >= vbArray Then Erase myZvarNewAry
  Dim i As Long
    Select Case coXbisRowDrctn
        Case True
            If TypeName(myZvarNewAry) = "String()" Then
                ReDim myZvarNewAry(UBound(myZvarOrgAry), 1) As String
            Else
                ReDim myZvarNewAry(UBound(myZvarOrgAry), 1) As Variant
            End If
            For i = LBound(myZvarOrgAry) To UBound(myZvarOrgAry)
                myZvarNewAry(i, 1) = myZvarOrgAry(i)
            Next i
        Case Else
            If TypeName(myZvarNewAry) = "String()" Then
                ReDim myZvarNewAry(1, UBound(myZvarOrgAry)) As String
            Else
                ReDim myZvarNewAry(1, UBound(myZvarOrgAry)) As Variant
            End If
            For i = LBound(myZvarOrgAry) To UBound(myZvarOrgAry)
                myZvarNewAry(1, i) = myZvarOrgAry(i)
            Next i
    End Select
End Sub

 '定型Ｐ_2次元配列変数のデータ一覧をシートに一括書出しする
Private Sub PfixWriteArrayVariablesToWorkSheet(myXbisExitFlag As Boolean, _
            myXobjFrstCell As Object, myZvarDataAry As Variant, _
            Optional coXbisEachWrtON As Boolean = False)
    myXbisExitFlag = False
    If myXobjFrstCell Is Nothing Then GoTo ExitPath
    If VarType(myZvarDataAry) < vbArray Then GoTo ExitPath
  Dim myXlonTmp As Long, m As Long: m = 0
    On Error Resume Next
    Do
        m = m + 1: myXlonTmp = UBound(myZvarDataAry, m)
    Loop While Err.Number = 0
    On Error GoTo 0
    If m - 1 <> 2 Then GoTo ExitPath
'//格納データをシートに書出し
    If UBound(myZvarDataAry, 1) <= 0 Then GoTo ExitPath
    If UBound(myZvarDataAry, 2) <= 0 Then GoTo ExitPath
  Dim myXlonRows As Long, myXlonCols As Long
    myXlonRows = UBound(myZvarDataAry, 1) - LBound(myZvarDataAry, 1) + 1
    myXlonCols = UBound(myZvarDataAry, 2) - LBound(myZvarDataAry, 2) + 1
    With myXobjFrstCell
        If .Parent.Rows.Count - .Row + 1 < myXlonRows Then GoTo ExitPath
        If .Parent.Columns.Count - .Column + 1 < myXlonCols Then GoTo ExitPath
    End With
    On Error GoTo ErrorPath
    If coXbisEachWrtON = False Then
        myXobjFrstCell.Resize(myXlonRows, myXlonCols) = myZvarDataAry
    Else
      Dim i As Long, j As Long
        For i = LBound(myZvarDataAry, 1) To UBound(myZvarDataAry, 1)
            For j = LBound(myZvarDataAry, 2) To UBound(myZvarDataAry, 2)
                myXobjFrstCell.Offset(i - 1, j - 1).Value = myZvarDataAry(i, j)
            Next j
        Next i
    End If
    On Error GoTo 0
    Exit Sub
ExitPath:
    myXbisExitFlag = True
'    MsgBox "データ書出しに失敗"     'Debug.Print
    Exit Sub
ErrorPath:
    myXobjFrstCell.Resize(myXlonRows, myXlonCols).NumberFormatLocal = "@"
    Resume
End Sub

      <br></pre>
    </body>
  </html>
